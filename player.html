<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuestra Historia - √Ålbum</title>

    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,700;1,400&family=Quicksand:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <script>
        if (!sessionStorage.getItem('authenticated')) {
            window.location.replace('login.html');
        }

        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'rose-love': '#e8c4c4',
                        'blue-dream': '#a8d8e6',
                        'sand': '#f5e6d3',
                        'cocoa': '#5a4638',
                        'glass': 'rgba(255, 255, 255, 0.25)',
                        'glass-border': 'rgba(255, 255, 255, 0.5)',
                        'glass-dark': 'rgba(255, 255, 255, 0.55)'
                    },
                    fontFamily: {
                        serif: ['"Playfair Display"', 'serif'],
                        sans: ['"Quicksand"', 'sans-serif']
                    },
                    animation: {
                        'spin-slow': 'spin 8s linear infinite',
                        'float': 'float 6s ease-in-out infinite',
                        'pulse-soft': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite'
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' }
                        }
                    }
                }
            }
        };
    </script>

    <style>
        :root {
            --glass: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.5);
        }

        body {
            background: linear-gradient(-45deg, #ff9a9e, #fad0c4, #fad0c4, #a18cd1, #fbc2eb);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            font-family: 'Quicksand', sans-serif;
            color: #5a4638;
            overflow-x: hidden;
        }

        body.player-open {
            overflow: hidden;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        @keyframes petalFall {
            0% {
                transform: translateY(-10vh) rotate(0deg);
                opacity: 0;
            }
            10% { opacity: .8; }
            100% {
                transform: translateY(110vh) translateX(30px) rotate(240deg);
                opacity: 0;
            }
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.5); border-radius: 10px; }

        .glass-panel {
            background: var(--glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }

        .vinyl-record {
            background: repeating-radial-gradient(#111 0, #111 2px, #333 3px, #333 4px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            position: relative;
            transition: transform 0.5s ease;
            animation-play-state: paused;
        }

        .vinyl-label {
            background-size: cover;
            background-position: center;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            border: 4px solid rgba(255,255,255,0.3);
        }

        .petal {
            position: absolute;
            background-color: #fff0f5;
            border-radius: 150% 0 150% 0;
            opacity: 0.8;
            pointer-events: none;
            z-index: 0;
            animation-name: petalFall;
            animation-timing-function: linear;
            animation-iteration-count: infinite;
        }

        .view-section {
            transition: opacity 0.35s ease, transform 0.35s ease;
            width: 100%;
            min-height: 100vh;
            padding-bottom: 110px;
        }

        .hidden-view {
            opacity: 0;
            pointer-events: none;
            transform: scale(0.98);
            z-index: -1;
            position: fixed;
            inset: 0;
        }

        .song-card {
            min-height: 120px;
        }

        .song-play-btn {
            width: 56px;
            height: 56px;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,.6);
            color: #fb7185;
            flex-shrink: 0;
        }

        .song-play-btn i {
            font-size: 22px;
            line-height: 1;
            margin-left: 2px;
        }

        #player-view {
            max-width: 100vw;
            overflow-x: hidden;
        }

        .lyrics-box {
            max-height: 290px;
            overflow-y: auto;
        }

        .dedication-box {
            max-height: 36vh;
            overflow-y: auto;
        }

        #dedication-card {
            scroll-margin-top: 16px;
        }

        .dedication-box::-webkit-scrollbar {
            width: 6px;
        }

        .dedication-box::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
        }

        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            height: 16px;
            width: 16px;
            border-radius: 50%;
            background: #ffffff;
            cursor: pointer;
            margin-top: -6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: rgba(255,255,255,0.4);
            border-radius: 2px;
        }

        @media (max-width: 767px) {
            #player-view {
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }
            .player-content {
                overflow-y: visible;
                padding-bottom: 24px;
                padding-top: 8px;
            }
            .vinyl-wrap { width: 220px; height: 220px; }
            .song-card { min-height: 98px; }
            .song-play-btn {
                width: 46px;
                height: 46px;
            }
            .song-play-btn i { font-size: 18px; }
            .lyrics-box { max-height: 35vh; }
            .dedication-box { max-height: 30vh; }
        }
    </style>
</head>
<body>
    <div id="petals-container" class="fixed inset-0 overflow-hidden pointer-events-none z-0"></div>

    <div id="menu-view" class="view-section relative z-10 px-4 py-8 md:px-8 max-w-7xl mx-auto">
        <header class="text-center mb-12 animate-float">
            <span class="inline-block py-1 px-4 rounded-full glass-panel text-sm font-semibold tracking-widest text-cocoa mb-4 uppercase">Para Ti</span>
            <h1 class="text-4xl md:text-6xl font-serif font-bold text-cocoa drop-shadow-sm mb-2">Nuestra Historia</h1>
            <p class="text-base md:text-xl text-cocoa/80 font-serif italic">Cada canci√≥n, un momento juntos.</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="songs-grid"></div>
    </div>

    <div id="player-view" class="hidden-view glass-panel fixed inset-0 z-50 flex flex-col backdrop-blur-xl bg-white/40">
        <div class="flex justify-between items-center p-4 md:p-6">
            <button onclick="toggleView('menu')" class="w-10 h-10 rounded-full glass-panel flex items-center justify-center hover:bg-white/40 transition" title="Minimizar">
                <i class="ph ph-caret-down text-2xl"></i>
            </button>
            <span class="text-[11px] md:text-xs font-bold tracking-widest uppercase opacity-60">Reproduciendo ahora</span>
            <button onclick="toggleLike()" id="like-btn" class="w-10 h-10 rounded-full glass-panel flex items-center justify-center hover:bg-white/40 transition text-rose-500">
                <i class="ph-fill ph-heart text-2xl"></i>
            </button>
        </div>

        <div id="player-content" class="flex-1 flex flex-col md:flex-row items-start justify-center gap-8 md:gap-12 px-4 md:px-6 pt-4 md:pt-6 overflow-y-auto pb-32 player-content">
            <div class="w-full md:max-w-xl flex flex-col items-center gap-6">
                <div class="relative w-64 h-64 md:w-96 md:h-96 flex-shrink-0 vinyl-wrap">
                    <div id="player-vinyl" class="vinyl-record w-full h-full rounded-full animate-spin-slow">
                        <div id="player-cover" class="vinyl-label w-1/2 h-1/2 shadow-inner"></div>
                    </div>
                </div>

                <div class="w-full max-w-md flex flex-col gap-5 text-center">
                    <div>
                        <h2 id="player-title" class="text-3xl md:text-5xl font-serif font-bold text-cocoa mb-2">T√≠tulo Canci√≥n</h2>
                        <p id="player-artist" class="text-lg md:text-xl opacity-75 font-serif italic">Artista / Cap√≠tulo</p>
                    </div>

                    <div class="w-full">
                        <input type="range" id="progress-bar" value="0" min="0" max="100" class="w-full h-1 rounded-lg appearance-none cursor-pointer">
                        <div class="flex justify-between text-xs font-mono opacity-60 mt-2">
                            <span id="current-time">0:00</span>
                            <span id="duration-time">0:00</span>
                        </div>
                    </div>

                    <div class="flex items-center justify-center gap-6">
                        <button onclick="playPrev()" class="text-3xl hover:scale-110 transition opacity-70 hover:opacity-100"><i class="ph-fill ph-skip-back"></i></button>

                        <button id="play-pause-btn" onclick="togglePlay()" class="w-20 h-20 bg-gradient-to-tr from-rose-400 to-rose-300 rounded-full shadow-lg flex items-center justify-center text-white text-4xl hover:shadow-xl hover:scale-105 transition transform">
                            <i class="ph-fill ph-play ml-1"></i>
                        </button>

                        <button onclick="playNext()" class="text-3xl hover:scale-110 transition opacity-70 hover:opacity-100"><i class="ph-fill ph-skip-forward"></i></button>
                    </div>

                </div>
            </div>

            <div class="w-full md:max-w-lg flex flex-col gap-4">
                <div class="flex items-center justify-center md:justify-start gap-3">
                    <button id="dedication-nav" onclick="scrollToDedication()" class="glass-panel px-4 py-2 rounded-full text-xs font-semibold">‚≠ê Dedicatoria</button>
                    <button id="lyrics-toggle" onclick="toggleLyrics()" class="glass-panel px-4 py-2 rounded-full text-xs font-semibold">üéµ Ocultar Letras</button>
                </div>
                <div id="dedication-card" class="glass-panel dedication-box p-5 rounded-2xl relative group">
                    <div class="absolute top-0 left-0 w-1 h-full bg-rose-400"></div>
                    <h3 class="text-xs font-bold uppercase tracking-widest text-rose-500 mb-2">Dedicatoria</h3>
                    <p id="player-dedication" class="text-sm md:text-base leading-relaxed italic opacity-90">Selecciona una canci√≥n para ver el mensaje especial...</p>
                </div>

                <div id="lyrics-card" class="glass-panel p-5 rounded-2xl">
                    <h3 class="text-xs font-bold uppercase tracking-widest text-rose-500 mb-2">Letra</h3>
                    <div id="lyrics-container" class="lyrics-box text-sm md:text-base leading-relaxed italic opacity-90"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="mini-player" onclick="toggleView('player')" class="fixed bottom-3 md:bottom-4 left-3 right-3 md:left-4 md:right-4 glass-panel rounded-2xl p-3 flex items-center gap-3 md:gap-4 shadow-2xl cursor-pointer transform translate-y-32 transition-transform duration-500 z-40 border border-white/60">
        <div id="mini-cover" class="w-11 h-11 md:w-12 md:h-12 rounded-full bg-cover bg-center border-2 border-white animate-spin-slow"></div>
        <div class="flex-1 min-w-0">
            <h4 id="mini-title" class="font-bold text-cocoa truncate text-sm">Selecciona una canci√≥n</h4>
            <p id="mini-artist" class="text-xs opacity-70 truncate">Nuestra Historia</p>
        </div>
        <button onclick="event.stopPropagation(); togglePlay()" class="w-10 h-10 flex items-center justify-center rounded-full bg-white/60 hover:bg-white text-cocoa transition">
            <i id="mini-play-icon" class="ph-fill ph-play text-lg"></i>
        </button>
    </div>

    <audio id="audio-element"></audio>

    <script src="js/tracks.js"></script>
    <script>
        let currentTrackIndex = 0;
        let isPlaying = false;
        let lyricsVisible = true;

        const audio = document.getElementById('audio-element');
        const songsGrid = document.getElementById('songs-grid');
        const playerView = document.getElementById('player-view');
        const miniPlayer = document.getElementById('mini-player');
        const playerTitle = document.getElementById('player-title');
        const playerArtist = document.getElementById('player-artist');
        const playerCover = document.getElementById('player-cover');
        const playerVinyl = document.getElementById('player-vinyl');
        const playerDedication = document.getElementById('player-dedication');
        const progressBar = document.getElementById('progress-bar');
        const currentTimeEl = document.getElementById('current-time');
        const durationTimeEl = document.getElementById('duration-time');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const lyricsCard = document.getElementById('lyrics-card');
        const lyricsContainer = document.getElementById('lyrics-container');
        const lyricsToggle = document.getElementById('lyrics-toggle');
        const dedicationCard = document.getElementById('dedication-card');
        const likeBtn = document.getElementById('like-btn');
        const playerContent = document.getElementById('player-content');

        function init() {
            renderSongs();
            setupAudioListeners();
            setupPetals();

            const urlParams = new URLSearchParams(window.location.search);
            const id = parseInt(urlParams.get('id'));
            const index = tracks.findIndex(t => t.id === id);
            if (index >= 0) {
                loadTrack(index, false);
                toggleView('player');
            }
        }

        function renderSongs() {
            songsGrid.innerHTML = tracks.map((track, index) => {
                const cover = track.coverImage || '';
                const title = track.title || 'Sin t√≠tulo';
                const artist = track.artist || '-';
                const chapter = track.description || `Cap√≠tulo ${track.id}`;

                return `
                <button type="button" onclick="openTrack(${index})" class="song-card group glass-panel p-4 rounded-2xl cursor-pointer hover:bg-white/40 transition-all duration-300 transform hover:-translate-y-1 hover:shadow-xl flex items-center gap-4 w-full text-left">
                    <div class="w-20 h-20 rounded-xl flex-shrink-0 shadow-md overflow-hidden bg-gradient-to-br from-rose-300 to-pink-400">
                        ${cover ? `<img src="${cover}" alt="${title}" class="w-full h-full object-cover">` : ''}
                    </div>

                    <div class="flex-1 min-w-0">
                        <p class="text-xs font-bold text-rose-500 tracking-[0.2em] uppercase mb-1">${chapter}</p>
                        <h3 class="text-xl font-serif font-bold text-cocoa truncate">${title}</h3>
                        <p class="text-sm text-cocoa/70 truncate">${artist}</p>
                    </div>

                    <span class="song-play-btn group-hover:bg-white/80 transition">
                        <i class="ph-fill ph-play"></i>
                    </span>
                </button>
                `;
            }).join('');
        }

        function openTrack(index) {
            loadTrack(index, true);
            toggleView('player');
        }

        function loadTrack(index, autoPlay = true) {
            currentTrackIndex = index;
            const track = tracks[index];

            audio.src = track.audioUrl || '';
            audio.load();

            playerTitle.innerText = track.title || 'Sin t√≠tulo';
            playerArtist.innerText = track.artist || '-';
            playerDedication.innerText = track.dedication || 'Sin dedicatoria';

            if (track.coverImage) {
                playerCover.style.background = `url('${track.coverImage}') center/cover`;
                document.getElementById('mini-cover').style.backgroundImage = `url('${track.coverImage}')`;
            } else {
                playerCover.style.background = 'linear-gradient(135deg,#f472b6,#fb7185)';
                document.getElementById('mini-cover').style.backgroundImage = 'none';
                document.getElementById('mini-cover').style.background = 'linear-gradient(135deg,#f472b6,#fb7185)';
            }

            document.getElementById('mini-title').innerText = track.title || 'Sin t√≠tulo';
            document.getElementById('mini-artist').innerText = track.artist || '-';
            miniPlayer.classList.remove('translate-y-32');

            renderLyrics(track.lyrics || []);
            lyricsVisible = true;
            lyricsCard.style.display = 'block';
            lyricsToggle.innerText = 'üéµ Ocultar Letras';
            playerContent.scrollTop = 0;
            playerView.scrollTop = 0;

            const likes = getLikes();
            likeBtn.classList.toggle('text-rose-600', likes.includes(track.id));

            window.history.replaceState({}, '', `player.html?id=${track.id}`);

            if (autoPlay && track.audioUrl) {
                playTrack();
            }
        }

        function renderLyrics(lyrics) {
            if (!lyrics || lyrics.length === 0) {
                lyricsContainer.innerHTML = '<p class="opacity-70">No hay letra disponible para esta canci√≥n.</p>';
                return;
            }

            let html = '';
            let sectionOpen = false;

            lyrics.forEach(line => {
                const text = (line.text || '').trim();
                if (!text || text === '‚ô™') return;

                const section = text.match(/^\[(.*)\]$/);
                if (section) {
                    if (sectionOpen) html += '</div>';
                    html += `<div class="mb-5"><p class="text-xs uppercase tracking-[0.2em] text-rose-500 font-bold mb-2">${section[1]}</p>`;
                    sectionOpen = true;
                } else {
                    if (!sectionOpen) {
                        html += '<div class="mb-5">';
                        sectionOpen = true;
                    }
                    html += `<p class="mb-1">${text}</p>`;
                }
            });

            if (sectionOpen) html += '</div>';
            lyricsContainer.innerHTML = html || '<p class="opacity-70">No hay letra disponible para esta canci√≥n.</p>';
        }

        function togglePlay() {
            if (!audio.src) return;
            if (audio.paused) {
                playTrack();
            } else {
                pauseTrack();
            }
        }

        function playTrack() {
            audio.play().then(() => {
                isPlaying = true;
                updatePlayIcons(true);
                playerVinyl.style.animationPlayState = 'running';
                document.getElementById('mini-cover').style.animationPlayState = 'running';
            }).catch(() => {});
        }

        function pauseTrack() {
            audio.pause();
            isPlaying = false;
            updatePlayIcons(false);
            playerVinyl.style.animationPlayState = 'paused';
            document.getElementById('mini-cover').style.animationPlayState = 'paused';
        }

        function updatePlayIcons(playing) {
            const iconClass = playing ? 'ph-pause' : 'ph-play';
            playPauseBtn.innerHTML = `<i class="ph-fill ${iconClass} ${playing ? '' : 'ml-1'}"></i>`;
            document.getElementById('mini-play-icon').className = `ph-fill ${iconClass} text-lg`;
        }

        function playNext() {
            let nextIndex = currentTrackIndex + 1;
            if (nextIndex >= tracks.length) nextIndex = 0;
            loadTrack(nextIndex, isPlaying);
        }

        function playPrev() {
            let prevIndex = currentTrackIndex - 1;
            if (prevIndex < 0) prevIndex = tracks.length - 1;
            loadTrack(prevIndex, isPlaying);
        }

        function setupAudioListeners() {
            audio.addEventListener('timeupdate', () => {
                const percent = (audio.currentTime / audio.duration) * 100;
                progressBar.value = percent || 0;
                currentTimeEl.innerText = formatTime(audio.currentTime);
                durationTimeEl.innerText = formatTime(audio.duration || 0);
            });

            progressBar.addEventListener('input', (e) => {
                if (!audio.duration) return;
                const seekTime = (audio.duration / 100) * e.target.value;
                audio.currentTime = seekTime;
            });

            audio.addEventListener('ended', playNext);
        }

        function formatTime(seconds) {
            const min = Math.floor(seconds / 60);
            const sec = Math.floor(seconds % 60);
            return `${min}:${sec < 10 ? '0' : ''}${sec}`;
        }

        function toggleView(view) {
            if (view === 'player') {
                playerView.classList.remove('hidden-view');
                document.body.classList.add('player-open');
                playerContent.scrollTop = 0;
                playerView.scrollTop = 0;
                playerView.animate(
                    [{ transform: 'translateY(100%)', opacity: 0 }, { transform: 'translateY(0)', opacity: 1 }],
                    { duration: 320, easing: 'cubic-bezier(0.22, 1, 0.36, 1)', fill: 'forwards' }
                );
            } else {
                const animation = playerView.animate(
                    [{ transform: 'translateY(0)', opacity: 1 }, { transform: 'translateY(100%)', opacity: 0 }],
                    { duration: 260, easing: 'ease-in', fill: 'forwards' }
                );

                animation.onfinish = () => {
                    playerView.classList.add('hidden-view');
                    document.body.classList.remove('player-open');
                };
            }
        }

        function toggleLyrics() {
            lyricsVisible = !lyricsVisible;
            lyricsCard.style.display = lyricsVisible ? 'block' : 'none';
            lyricsToggle.innerText = lyricsVisible ? 'üéµ Ocultar Letras' : 'üìù Ver Letras';
            playerContent.scrollTop = 0;
        }

        function scrollToDedication() {
            dedicationCard.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function getLikes() {
            return JSON.parse(localStorage.getItem('likedTracks') || '[]');
        }

        function toggleLike() {
            const likes = getLikes();
            const trackId = tracks[currentTrackIndex]?.id;
            if (!trackId) return;

            const exists = likes.indexOf(trackId);
            if (exists >= 0) {
                likes.splice(exists, 1);
            } else {
                likes.push(trackId);
            }

            localStorage.setItem('likedTracks', JSON.stringify(likes));
            likeBtn.classList.toggle('text-rose-600', likes.includes(trackId));
        }

        function setupPetals() {
            const container = document.getElementById('petals-container');
            for (let i = 0; i < 16; i++) {
                const petal = document.createElement('div');
                petal.classList.add('petal');
                const size = Math.random() * 10 + 5;
                petal.style.width = `${size}px`;
                petal.style.height = `${size}px`;
                petal.style.left = `${Math.random() * 100}%`;
                petal.style.animationDuration = `${Math.random() * 8 + 10}s`;
                petal.style.animationDelay = `${Math.random() * 8}s`;
                container.appendChild(petal);
            }
        }

        init();
    </script>
</body>
</html>
